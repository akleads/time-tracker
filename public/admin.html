<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - AK LEADS TIME BASED REDIRECT TOOL</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="stylesheet" href="/css/admin.css">
  <link rel="stylesheet" href="/css/schedule-grid.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>AK LEADS TIME BASED REDIRECT TOOL</h1>
      <div class="user-info">
        <span id="username"></span>
        <button id="logoutBtn" class="btn btn-secondary">Logout</button>
      </div>
    </header>
    
    <main>
      <!-- Always visible migration button for admins -->
      <div id="alwaysVisibleMigrationWarning" style="display: block; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 16px; margin-bottom: 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
          <div>
            <strong style="font-size: 16px; color: #856404;">‚ö†Ô∏è Database Migration Required</strong>
            <p style="margin: 8px 0 0 0; font-size: 14px; color: #856404;">Your database needs to be updated to support new features (like creating reusable offers). Click the button to run the migration.</p>
          </div>
          <button id="alwaysVisibleRunMigrationBtn" class="btn btn-primary" onclick="runMigration()" style="white-space: nowrap;">
            üîÑ Run Database Migration
          </button>
        </div>
      </div>
      
      <div id="adminSection" class="admin-section" style="display: none;">
        <div class="collapsible-section">
          <div class="section-header" onclick="toggleSection('adminMenuSection')">
            <h2>Admin</h2>
            <span class="collapse-icon" id="adminMenuSectionIcon">‚ñ∂</span>
          </div>
          <div id="adminMenuSection" class="collapsible-content collapsed">
            <div class="collapsible-section" style="margin-bottom: 16px;">
              <div class="section-header" onclick="toggleSection('usersManagementSection')">
                <h3>User Management</h3>
                <div class="section-header-actions">
                  <button id="refreshUsersBtn" class="btn btn-small btn-secondary" onclick="event.stopPropagation(); loadPendingUsers(); loadAllUsers();">Refresh</button>
                  <span class="collapse-icon" id="usersManagementSectionIcon">‚ñ∂</span>
                </div>
              </div>
              <div id="usersManagementSection" class="collapsible-content collapsed">
                <div style="margin-bottom: 24px;">
                  <div id="migrationWarning" style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 12px; margin-bottom: 20px; display: none;">
                    <strong>‚ö†Ô∏è Database Migration Required</strong>
                    <p style="margin: 8px 0; font-size: 13px;">Your database needs to be updated to support new features. Click the button below to run the migration.</p>
                    <button id="runMigrationBtn" class="btn btn-small btn-primary" onclick="event.stopPropagation(); runMigration();">Run Database Migration</button>
                  </div>
                  <h4>Pending User Approvals</h4>
                  <div id="pendingUsersList" class="pending-users-list"></div>
                </div>
                <div style="margin-top: 32px; border-top: 1px solid var(--border-color); padding-top: 24px;">
                  <h4>All Users</h4>
                  <div id="allUsersList" class="pending-users-list"></div>
                </div>
              </div>
            </div>
            
            <div class="collapsible-section">
              <div class="section-header" onclick="toggleSection('domainsSection')">
                <h3>Custom Domains</h3>
                <div class="section-header-actions">
                  <button id="createDomainBtn" class="btn btn-primary btn-small" onclick="event.stopPropagation();">+ Add Domain</button>
                  <span class="collapse-icon" id="domainsSectionIcon">‚ñ∂</span>
                </div>
              </div>
              <div id="domainsSection" class="collapsible-content collapsed">
                <div id="domainsList" class="pending-users-list"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      
      <div class="campaigns-section">
        <div class="collapsible-section">
          <div class="section-header" onclick="toggleSection('campaignsSection')">
            <h2>Campaigns</h2>
            <div class="section-header-actions">
              <button id="refreshCampaignStatsBtn" class="btn btn-small btn-secondary" onclick="event.stopPropagation(); refreshCampaignStats();" title="Refresh Statistics">üîÑ Refresh Stats</button>
              <button id="createCampaignBtn" class="btn btn-primary" onclick="event.stopPropagation();">+ Create Campaign</button>
              <span class="collapse-icon" id="campaignsSectionIcon">‚ñ∂</span>
            </div>
          </div>
          <div id="campaignsSection" class="collapsible-content collapsed">
            <div id="campaignsList" class="campaigns-list"></div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Create/Edit Campaign Modal -->
  <div id="campaignModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Create Campaign</h3>
        <span class="close">&times;</span>
      </div>
      <form id="campaignForm">
        <input type="hidden" id="campaignId">
        <div class="form-group">
          <label for="campaignName">Campaign Name</label>
          <input type="text" id="campaignName" required>
        </div>
        <div class="form-group">
          <label for="campaignSlug">Slug (optional, auto-generated if empty)</label>
          <input type="text" id="campaignSlug" pattern="[a-zA-Z0-9]{3,50}">
        </div>
        <div class="form-group">
          <label for="campaignTimezone">Timezone</label>
          <select id="campaignTimezone">
            <option value="UTC">UTC</option>
            <option value="America/New_York">Eastern Time (ET)</option>
            <option value="America/Chicago">Central Time (CT)</option>
            <option value="America/Denver">Mountain Time (MT)</option>
            <option value="America/Los_Angeles">Pacific Time (PT)</option>
            <option value="Europe/London">London (GMT)</option>
            <option value="Europe/Paris">Paris (CET)</option>
            <option value="Asia/Tokyo">Tokyo (JST)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="campaignDomain">Custom Domain (optional)</label>
          <select id="campaignDomain">
            <option value="">Use default domain</option>
          </select>
          <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
            Select a custom domain for this campaign's redirect links. This domain will be used in the redirect template.
          </small>
        </div>
        <div class="form-group">
          <label for="redtrackCampaignId">RedTrack Campaign ID</label>
          <input type="text" id="redtrackCampaignId" placeholder="69544cd027f4f960ed920e70">
          <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
            The RedTrack campaign ID to use in the redirect script. This will be included in the rtkcmpid parameter.
          </small>
        </div>
        <div class="form-group">
          <label for="numberOfOffers">Number of Offers</label>
          <input type="number" id="numberOfOffers" min="1" value="1" required>
          <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
            The number of offer positions in this campaign. Each position will redirect to a different RedTrack offer (click/1, click/2, etc.).
          </small>
        </div>
        <div class="form-group" id="offerPositionsGroup">
          <label>Offer Position Titles (optional)</label>
          <div id="offerPositionsList"></div>
          <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
            Add titles to identify each offer position. These are for your reference only.
          </small>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelCampaignBtn">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Campaign Details Modal -->
  <div id="campaignDetailsModal" class="modal" style="display: none;">
    <div class="modal-content large">
      <div class="modal-header">
        <h3 id="campaignDetailsTitle">Campaign Details</h3>
        <span class="close">&times;</span>
      </div>
      <div id="campaignDetailsContent"></div>
    </div>
  </div>
  
  <!-- Create/Edit Offer Modal -->
  <div id="offerModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="offerModalTitle">Create Offer</h3>
        <span class="close">&times;</span>
      </div>
      <form id="offerForm">
        <input type="hidden" id="offerId">
        <div class="form-group">
          <label for="offerName">Offer Name</label>
          <input type="text" id="offerName" required>
        </div>
        <div class="form-group">
          <label for="offerUrl">Offer URL</label>
          <input type="url" id="offerUrl" required>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelOfferBtn">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Domain Modal -->
  <div id="domainModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="domainModalTitle">Add Custom Domain</h3>
        <span class="close">&times;</span>
      </div>
      <form id="domainForm">
        <input type="hidden" id="domainId">
            <div class="form-group">
              <label for="domainName">Domain (e.g., t.safeuinsurance.com)</label>
              <input type="text" id="domainName" placeholder="t.safeuinsurance.com" required>
              <small style="color: #666; margin-top: 5px; display: block;">
                Point a CNAME record from this domain to your Render service hostname (e.g., <code>time-tracker.onrender.com</code>).<br>
                Example: In your DNS provider, create a CNAME record: <code>t.safeuinsurance.com</code> ‚Üí <code>time-tracker.onrender.com</code>
              </small>
            </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="domainActive" checked> Active
          </label>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelDomainBtn">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Time Rule Modal -->
  <div id="timeRuleModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="timeRuleModalTitle">Add Time Rule</h3>
        <span class="close">&times;</span>
      </div>
      <form id="timeRuleForm">
        <input type="hidden" id="timeRuleId">
        <input type="hidden" id="timeRuleCampaignId">
        <div class="form-group">
          <label for="timeRuleOfferPosition">Offer Position</label>
          <select id="timeRuleOfferPosition" required></select>
          <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
            Select which offer position (1, 2, 3, etc.) should be used during this time period.
          </small>
        </div>
        <div class="form-group">
          <label for="timeRuleType">Rule Type</label>
          <select id="timeRuleType" required>
            <option value="range">Time Range</option>
            <option value="specific">Specific Time</option>
          </select>
        </div>
        <div class="form-group">
          <label for="timeRuleStartTime">Start Time</label>
          <input type="time" id="timeRuleStartTime" required>
        </div>
        <div class="form-group" id="timeRuleEndTimeGroup">
          <label for="timeRuleEndTime">End Time</label>
          <input type="time" id="timeRuleEndTime">
        </div>
        <div class="form-group">
          <label for="timeRuleDayOfWeek">Day of Week (optional - leave blank for all days)</label>
          <select id="timeRuleDayOfWeek">
            <option value="">All Days</option>
            <option value="0">Sunday</option>
            <option value="1">Monday</option>
            <option value="2">Tuesday</option>
            <option value="3">Wednesday</option>
            <option value="4">Thursday</option>
            <option value="5">Friday</option>
            <option value="6">Saturday</option>
          </select>
        </div>
        <div class="form-group">
          <label for="timeRuleTimezone">Timezone (optional - uses campaign default if not set)</label>
          <select id="timeRuleTimezone">
            <option value="">Use Campaign Default</option>
            <option value="UTC">UTC</option>
            <option value="America/New_York">Eastern Time (ET)</option>
            <option value="America/Chicago">Central Time (CT)</option>
            <option value="America/Denver">Mountain Time (MT)</option>
            <option value="America/Los_Angeles">Pacific Time (PT)</option>
            <option value="Europe/London">London (GMT)</option>
            <option value="Europe/Paris">Paris (CET)</option>
            <option value="Asia/Tokyo">Tokyo (JST)</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelTimeRuleBtn">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Toast Notification Container -->
  <div id="toastContainer" class="toast-container"></div>

  <script src="/js/schedule-grid.js"></script>
  <script src="/js/admin.js"></script>
  <script src="/js/domains.js"></script>
</body>
</html>
